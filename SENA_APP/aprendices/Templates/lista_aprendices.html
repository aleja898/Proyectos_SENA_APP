{% extends 'base.html' %}

{% block title %}Lista de Aprendices - SENA APP{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div class="mb-3 mb-md-0">
                <h1 class="display-5 fw-bold mb-2" style="color: #008000;">
                    üë• Lista de Aprendices
                </h1>
                <p class="lead text-muted mb-0">
                    Informaci√≥n completa de todos los estudiantes registrados
                </p>
            </div>
            <div>
                <a href="{% url 'aprendices:inicio' %}" class="back-link">
                    ‚Üê Regresar al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üìä</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #008000;">{{ total_aprendices }}</h4>
                    <small class="text-muted">Total de Aprendices</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üéì</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #ff6600;">Activos</h4>
                    <small class="text-muted">En Formaci√≥n</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üìö</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #008000;">2025</h4>
                    <small class="text-muted">A√±o Actual</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Table Card -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <span style="font-size: 1.5rem; margin-right: 15px;">üìã</span>
                    <div>
                        <h5 class="mb-1">Registro de Aprendices</h5>
                        <small class="opacity-75">Lista detallada con informaci√≥n de contacto</small>
                    </div>
                </div>
                <div class="badge badge-sena fs-6 px-3 py-2">
                    {{ total_aprendices }} registros
                </div>
            </div>
            <div class="card-body p-0">
                {% if lista_aprendices %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 80px;">
                                        <i class="fas fa-hashtag"></i> ID
                                    </th>
                                    <th>
                                        <i class="fas fa-id-card"></i> Documento
                                    </th>
                                    <th>
                                        <i class="fas fa-user"></i> Nombre Completo
                                    </th>
                                    <th>
                                        <i class="fas fa-graduation-cap"></i> Programa
                                    </th>
                                    <th>
                                        <i class="fas fa-envelope"></i> Correo
                                    </th>
                                    <th>
                                        <i class="fas fa-phone"></i> Tel√©fono
                                    </th>
                                    <th>
                                        <i class="fas fa-map-marker-alt"></i> Ciudad
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-cogs"></i> Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for aprendiz in lista_aprendices %}
                                <tr>
                                    <td class="text-center fw-bold">
                                        <span class="badge" style="background: linear-gradient(135deg, #008000 0%, #ff6600 100%); color: white;">
                                            {{ aprendiz.id }}
                                        </span>
                                    </td>
                                    <td class="fw-semibold" style="color: #2d3436;">
                                        {{ aprendiz.documento_identidad }}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="instructor-avatar me-3" style="width: 40px; height: 40px; font-size: 1rem;">
                                                {{ aprendiz.nombre|first }}{{ aprendiz.apellido|first }}
                                            </div>
                                            <div>
                                                <div class="fw-bold" style="color: #2d3436;">
                                                    {{ aprendiz.nombre }} {{ aprendiz.apellido }}
                                                </div>
                                                <small class="text-muted">
                                                    Nacido: {{ aprendiz.fecha_nacimiento|date:"d/m/Y"|default:"No registrada" }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if aprendiz.programa %}
                                            <span class="badge badge-sena px-3 py-2" title="{{ aprendiz.programa }}">
                                                {{ aprendiz.programa|truncatechars:25 }}
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary px-3 py-2">
                                                No asignado
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aprendiz.correo %}
                                            <div class="d-flex align-items-center">
                                                <span style="color: #008000; margin-right: 8px;">@</span>
                                                <a href="mailto:{{ aprendiz.correo }}" class="text-decoration-none text-muted" title="{{ aprendiz.correo }}">
                                                    {{ aprendiz.correo|truncatechars:20 }}
                                                </a>
                                            </div>
                                        {% else %}
                                            <span class="text-muted fst-italic">No registrado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aprendiz.telefono %}
                                            <div class="d-flex align-items-center">
                                                <span style="color: #ff6600; margin-right: 8px;">üìû</span>
                                                <a href="tel:{{ aprendiz.telefono }}" class="text-decoration-none text-muted">
                                                    {{ aprendiz.telefono }}
                                                </a>
                                            </div>
                                        {% else %}
                                            <span class="text-muted fst-italic">No registrado</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if aprendiz.ciudad %}
                                            <div class="d-flex align-items-center">
                                                <span style="color: #008000; margin-right: 8px;">üìç</span>
                                                <span class="text-muted">{{ aprendiz.ciudad }}</span>
                                            </div>
                                        {% else %}
                                            <span class="text-muted fst-italic">No registrada</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'aprendices:detalle_aprendiz' aprendiz.id %}" 
                                               class="btn btn-info btn-sm px-3" 
                                               title="Ver detalles completos">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-outline-info btn-sm" 
                                                    onclick="verModalDetalle({{ aprendiz.id }})" 
                                                    title="Vista r√°pida">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div style="font-size: 6rem; margin-bottom: 20px;">üì≠</div>
                        <h4 class="fw-bold mb-3" style="color: #ff6600;">No hay aprendices registrados</h4>
                        <p class="text-muted mb-4">
                            A√∫n no se han registrado aprendices en el sistema.
                        </p>
                        <a href="/admin/" class="btn btn-primary btn-lg px-4">
                            Agregar Primer Aprendiz
                        </a>
                    </div>
                {% endif %}
            </div>
            {% if lista_aprendices %}
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando {{ lista_aprendices|length }} de {{ total_aprendices }} aprendices registrados
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            √öltima actualizaci√≥n: {% now "d/m/Y H:i" %}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Action Buttons -->
{% if lista_aprendices %}
<div class="row mt-4">
    <div class="col-12 text-center">
        <div class="d-flex flex-wrap justify-content-center gap-3">
            <a href="agregar_aprendiz" class="btn btn-primary btn-lg px-4">
                <i class="fas fa-plus me-2"></i>Agregar Nuevo Aprendiz
            </a>
            <button class="btn btn-success btn-lg px-4" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Imprimir Lista
            </button>
            <a href="{% url 'aprendices:inicio' %}" class="btn btn-secondary btn-lg px-4">
                <i class="fas fa-home me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para vista r√°pida del aprendiz -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <span style="font-size: 1.5rem; margin-right: 15px;">üë§</span>
                    <div>
                        <h5 class="modal-title mb-1" id="modalDetalleLabel">Vista R√°pida - Aprendiz</h5>
                        <small class="opacity-75">Datos b√°sicos del estudiante</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody">
                <!-- Los detalles se cargar√°n aqu√≠ din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
                <a href="aprendices:detalle_aprendiz" id="btnVerCompleto" class="btn btn-success">
                    <i class="fas fa-eye me-2"></i>Ver Detalles Completos
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function verModalDetalle(aprendizId) {
    // Buscar el aprendiz en la tabla
    const filas = document.querySelectorAll('tbody tr');
    let aprendiz = null;
    
    filas.forEach(fila => {
        const idCell = fila.querySelector('td .badge');
        if (idCell && idCell.textContent.trim() == aprendizId) {
            const celdas = fila.querySelectorAll('td');
            aprendiz = {
                id: aprendizId,
                documento: celdas[1].textContent.trim(),
                nombre: celdas[2].querySelector('.fw-bold').textContent.trim(),
                fechaNacimiento: celdas[2].querySelector('small') ? 
                    celdas[2].querySelector('small').textContent.replace('Nacido: ', '').trim() : 'No registrada',
                programa: celdas[3].querySelector('.badge') ? 
                    celdas[3].querySelector('.badge').getAttribute('title') || celdas[3].querySelector('.badge').textContent.trim() : 'No asignado',
                correo: celdas[4].querySelector('a') ? 
                    celdas[4].querySelector('a').getAttribute('href').replace('mailto:', '') : 'No registrado',
                telefono: celdas[5].querySelector('a') ? 
                    celdas[5].querySelector('a').getAttribute('href').replace('tel:', '') : 'No registrado',
                ciudad: celdas[6].querySelector('.text-muted') ? 
                    celdas[6].querySelector('.text-muted').textContent.trim() : 'No registrada'
            };
        }
    });
    
    if (aprendiz) {
        // Actualizar el enlace "Ver Detalles Completos"
        document.getElementById('btnVerCompleto').href = `/aprendiz/${aprendiz.id}/`;
        
        document.getElementById('modalDetalleBody').innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center mb-4">
                    <div class="instructor-avatar mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;">
                        ${aprendiz.nombre.split(' ')[0][0]}${aprendiz.nombre.split(' ').length > 1 ? aprendiz.nombre.split(' ')[1][0] : ''}
                    </div>
                    <h5 class="fw-bold" style="color: #008000;">ID: ${aprendiz.id}</h5>
                    <p class="text-muted mb-0">${aprendiz.documento}</p>
                </div>
                <div class="col-md-8">
                    <div class="info-item">
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üë§ Nombre Completo:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span class="fw-semibold">${aprendiz.nombre}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìÖ Fecha Nacimiento:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span>${aprendiz.fechaNacimiento}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üéì Programa:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span class="badge badge-sena px-3 py-2">${aprendiz.programa}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìß Correo:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                ${aprendiz.correo !== 'No registrado' ? 
                                    `<a href="mailto:${aprendiz.correo}" class="text-decoration-none" style="color: #008000;">${aprendiz.correo}</a>` : 
                                    '<span class="text-muted fst-italic">No registrado</span>'
                                }
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìû Tel√©fono:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                ${aprendiz.telefono !== 'No registrado' ? 
                                    `<a href="tel:${aprendiz.telefono}" class="text-decoration-none" style="color: #008000;">${aprendiz.telefono}</a>` : 
                                    '<span class="text-muted fst-italic">No registrado</span>'
                                }
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-0">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìç Ciudad:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span>${aprendiz.ciudad}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert" style="background: rgba(0, 128, 0, 0.1); border-left: 4px solid #008000;">
                        <div class="d-flex align-items-center">
                            <span style="color: #008000; margin-right: 10px;">‚ÑπÔ∏è</span>
                            <div>
                                <strong>Informaci√≥n del Sistema:</strong>
                                <p class="mb-0 mt-1">
                                    Este aprendiz est√° registrado en el sistema SENA APP. Para ver informaci√≥n completa incluyendo cursos y historial acad√©mico, haga clic en "Ver Detalles Completos".
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
        modal.show();
    }
}

// Funcionalidad adicional para mejorar la experiencia del usuario
document.addEventListener('DOMContentLoaded', function() {
    // A√±adir efecto de carga a la tabla
    const table = document.querySelector('table');
    if (table) {
        table.style.opacity = '0';
        table.style.transform = 'translateY(20px)';
        table.style.transition = 'all 0.6s ease';
        
        setTimeout(() => {
            table.style.opacity = '1';
            table.style.transform = 'translateY(0)';
        }, 100);
    }
    
    // Mejorar la experiencia de hover en las filas
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0, 184, 148, 0.08)';
            this.style.borderLeft = '4px solid #00b894';
            this.style.paddingLeft = '8px';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.borderLeft = '';
            this.style.paddingLeft = '';
        });
    });
    
    // Agregar campo de b√∫squeda din√°micamente
    const cardHeader = document.querySelector('.card-header');
    if (cardHeader && document.querySelector('table')) {
        const searchContainer = document.createElement('div');
        searchContainer.className = 'mt-3';
        searchContainer.innerHTML = `
            <div class="input-group">
                <span class="input-group-text" style="background: linear-gradient(135deg, #008000 0%, #ff6600 100%); color: white; border: none;">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="busquedaAprendices" 
                       placeholder="Buscar por nombre, documento, correo, programa..." 
                       onkeyup="filtrarAprendices()"
                       style="border-left: none;">
            </div>
        `;
        cardHeader.appendChild(searchContainer);
    }
});

// Funcionalidad de b√∫squeda en tiempo real
function filtrarAprendices() {
    const input = document.getElementById('busquedaAprendices');
    const filter = input.value.toLowerCase();
    const table = document.querySelector('table tbody');
    const rows = table.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            if (cells[j]) {
                const textValue = cells[j].textContent || cells[j].innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}
</script>
{% endblock %}