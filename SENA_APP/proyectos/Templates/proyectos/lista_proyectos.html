{% extends 'base.html' %}

{% block title %}Lista de Proyectos - SENA APP{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div class="mb-3 mb-md-0">
                <h1 class="display-5 fw-bold mb-2" style="color: #008000;">
                    üéØ Lista de Proyectos
                </h1>
                <p class="lead text-muted mb-0">
                    Informaci√≥n completa de todos los proyectos registrados en el sistema
                </p>
            </div>
            <div>
                <a href="{% url 'aprendices:inicio' %}" class="back-link">
                    ‚Üê Regresar al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Summary -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üìä</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #008000;">{{ total_proyectos }}</h4>
                    <small class="text-muted">Total de Proyectos</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üöÄ</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #ff6600;">Activos</h4>
                    <small class="text-muted">En Desarrollo</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-item text-center">
            <div class="d-flex align-items-center justify-content-center mb-2">
                <span style="font-size: 1.5rem; margin-right: 10px;">üìÖ</span>
                <div>
                    <h4 class="mb-0 fw-bold" style="color: #008000;">2025</h4>
                    <small class="text-muted">A√±o Actual</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Table Card -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <span style="font-size: 1.5rem; margin-right: 15px;">üìã</span>
                    <div>
                        <h5 class="mb-1">Registro de Proyectos</h5>
                        <small class="opacity-75">Lista detallada con informaci√≥n de cada proyecto</small>
                    </div>
                </div>
                <div class="badge badge-sena fs-6 px-3 py-2">
                    {{ total_proyectos }} registros
                </div>
            </div>
            <div class="card-body p-0">
                {% if lista_proyectos %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th class="text-center" style="width: 80px;">
                                        <i class="fas fa-hashtag"></i> ID
                                    </th>
                                    <th>
                                        <i class="fas fa-project-diagram"></i> T√≠tulo del Proyecto
                                    </th>
                                    <th>
                                        <i class="fas fa-building"></i> √Årea Proponente
                                    </th>
                                    <th>
                                        <i class="fas fa-user-tie"></i> Responsable
                                    </th>
                                    <th>
                                        <i class="fas fa-dollar-sign"></i> Presupuesto
                                    </th>
                                    <th>
                                        <i class="fas fa-calendar-alt"></i> Fecha Creaci√≥n
                                    </th>
                                    <th class="text-center" style="width: 120px;">
                                        <i class="fas fa-cogs"></i> Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for proyecto in lista_proyectos %}
                                <tr>
                                    <td class="text-center fw-bold">
                                        <span class="badge" style="background: linear-gradient(135deg, #008000 0%, #ff6600 100%); color: white;">
                                            {{ proyecto.id }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="programa-icon me-3" style="width: 40px; height: 40px; font-size: 1rem; background: linear-gradient(135deg, #008000 0%, #ff6600 100%);">
                                                üéØ
                                            </div>
                                            <div>
                                                <div class="fw-bold" style="color: #2d3436;">
                                                    <a href="{% url 'proyectos:detalle_proyecto' proyecto.id %}" class="text-decoration-none" style="color: #008000;">
                                                        {{ proyecto.titulo|truncatechars:40 }}
                                                    </a>
                                                </div>
                                                <small class="text-muted">
                                                    {{ proyecto.descripcion_detallada|truncatechars:50 }}
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-sena px-3 py-2">
                                            {{ proyecto.area_proponente }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="instructor-avatar me-3" style="width: 35px; height: 35px; font-size: 0.9rem;">
                                                {{ proyecto.responsable|first }}
                                            </div>
                                            <div>
                                                <div class="fw-semibold" style="color: #2d3436;">
                                                    {{ proyecto.responsable }}
                                                </div>
                                                <small class="text-muted">Responsable</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span style="color: #008000; margin-right: 8px;">üí∞</span>
                                            <div>
                                                <div class="fw-bold" style="color: #008000;">
                                                    ${{ proyecto.presupuesto_estimado|floatformat:0 }}
                                                </div>
                                                <small class="text-muted">COP</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span style="color: #ff6600; margin-right: 8px;">üìÖ</span>
                                            <div>
                                                <div class="fw-semibold">{{ proyecto.fecha_creacion|date:"d M Y" }}</div>
                                                <small class="text-muted">{{ proyecto.fecha_creacion|date:"H:i" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'proyectos:detalle_proyecto' proyecto.id %}" 
                                               class="btn btn-info btn-sm px-3" 
                                               title="Ver detalles completos">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-outline-info btn-sm" 
                                                    onclick="verModalDetalle('{{ proyecto.id }}')" 
                                                    title="Vista r√°pida">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <div style="font-size: 6rem; margin-bottom: 20px;">üî≠</div>
                        <h4 class="fw-bold mb-3" style="color: #ff6600;">No hay proyectos registrados</h4>
                        <p class="text-muted mb-4">
                            A√∫n no se han registrado proyectos en el sistema.
                        </p>
                        <a href="{% url 'proyectos:agregar_proyecto' %}" class="btn btn-primary btn-lg px-4">
                            Agregar Primer Proyecto
                        </a>
                    </div>
                {% endif %}
            </div>
            {% if lista_proyectos %}
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Mostrando {{ lista_proyectos|length }} de {{ total_proyectos }} proyectos registrados
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            √öltima actualizaci√≥n: {% now "d/m/Y H:i" %}
                        </small>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Action Buttons -->
{% if lista_proyectos %}
<div class="row mt-4">
    <div class="col-12 text-center">
        <div class="d-flex flex-wrap justify-content-center gap-3">
            <a href="{% url 'proyectos:agregar_proyecto' %}" class="btn btn-primary btn-lg px-4">
                <i class="fas fa-plus me-2"></i>Agregar Nuevo Proyecto
            </a>
            <button class="btn btn-success btn-lg px-4" onclick="window.print()">
                <i class="fas fa-print me-2"></i>Imprimir Lista
            </button>
            <a href="{% url 'aprendices:inicio' %}" class="btn btn-secondary btn-lg px-4">
                <i class="fas fa-home me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para vista r√°pida del proyecto -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex align-items-center">
                    <span style="font-size: 1.5rem; margin-right: 15px;">üéØ</span>
                    <div>
                        <h5 class="modal-title mb-1" id="modalDetalleLabel">Vista R√°pida - Proyecto</h5>
                        <small class="opacity-75">Datos b√°sicos del proyecto</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody">
                <!-- Los detalles se cargar√°n aqu√≠ din√°micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
                <a href="#" id="btnVerCompleto" class="btn btn-success">
                    <i class="fas fa-eye me-2"></i>Ver Detalles Completos
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function verModalDetalle(proyectoId) {
    // Buscar el proyecto en la tabla
    const filas = document.querySelectorAll('tbody tr');
    let proyecto = null;
    
    filas.forEach(fila => {
        const idCell = fila.querySelector('td .badge');
        if (idCell && idCell.textContent.trim() == proyectoId) {
            const celdas = fila.querySelectorAll('td');
            proyecto = {
                id: proyectoId,
                titulo: celdas[1].querySelector('.fw-bold a').textContent.trim(),
                descripcion: celdas[1].querySelector('small').textContent.trim(),
                area: celdas[2].querySelector('.badge').textContent.trim(),
                responsable: celdas[3].querySelector('.fw-semibold').textContent.trim(),
                presupuesto: celdas[4].querySelector('.fw-bold').textContent.trim(),
                fecha: celdas[5].querySelector('.fw-semibold').textContent.trim() + ' ' + 
                       celdas[5].querySelector('small').textContent.trim()
            };
        }
    });
    
    if (proyecto) {
        // Actualizar el enlace "Ver Detalles Completos"
        document.getElementById('btnVerCompleto').href = `/proyecto/${proyecto.id}/`;
        
        document.getElementById('modalDetalleBody').innerHTML = `
            <div class="row">
                <div class="col-md-4 text-center mb-4">
                    <div class="programa-icon mx-auto mb-3" style="width: 100px; height: 100px; font-size: 2.5rem;">
                        üéØ
                    </div>
                    <h5 class="fw-bold" style="color: #008000;">ID: ${proyecto.id}</h5>
                    <p class="text-muted mb-0">${proyecto.area}</p>
                </div>
                <div class="col-md-8">
                    <div class="info-item">
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üéØ T√≠tulo:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span class="fw-semibold">${proyecto.titulo}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìù Descripci√≥n:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span>${proyecto.descripcion}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üè¢ √Årea Proponente:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span class="badge badge-sena px-3 py-2">${proyecto.area}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üë®‚Äçüíº Responsable:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span>${proyecto.responsable}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-3">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üí∞ Presupuesto:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span class="fw-bold" style="color: #008000;">${proyecto.presupuesto}</span>
                            </div>
                        </div>
                        <hr style="border-color: #008000; opacity: 0.3;">
                        
                        <div class="row mb-0">
                            <div class="col-sm-4">
                                <strong style="color: #ff6600;">
                                    üìÖ Fecha Creaci√≥n:
                                </strong>
                            </div>
                            <div class="col-sm-8">
                                <span>${proyecto.fecha}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-12">
                    <div class="alert" style="background: rgba(0, 128, 0, 0.1); border-left: 4px solid #008000;">
                        <div class="d-flex align-items-center">
                            <span style="color: #008000; margin-right: 10px;">‚ÑπÔ∏è</span>
                            <div>
                                <strong>Informaci√≥n del Sistema:</strong>
                                <p class="mb-0 mt-1">
                                    Este proyecto est√° registrado en el sistema SENA APP. Para ver informaci√≥n completa incluyendo objetivos, recursos y cronograma, haga clic en "Ver Detalles Completos".
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
        modal.show();
    }
}

// Funcionalidad adicional para mejorar la experiencia del usuario
document.addEventListener('DOMContentLoaded', function() {
    // A√±adir efecto de carga a la tabla
    const table = document.querySelector('table');
    if (table) {
        table.style.opacity = '0';
        table.style.transform = 'translateY(20px)';
        table.style.transition = 'all 0.6s ease';
        
        setTimeout(() => {
            table.style.opacity = '1';
            table.style.transform = 'translateY(0)';
        }, 100);
    }
    
    // Mejorar la experiencia de hover en las filas
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'rgba(0, 184, 148, 0.08)';
            this.style.borderLeft = '4px solid #00b894';
            this.style.paddingLeft = '8px';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.borderLeft = '';
            this.style.paddingLeft = '';
        });
    });
    
    // Agregar campo de b√∫squeda din√°micamente
    const cardHeader = document.querySelector('.card-header');
    if (cardHeader && document.querySelector('table')) {
        const searchContainer = document.createElement('div');
        searchContainer.className = 'mt-3';
        searchContainer.innerHTML = `
            <div class="input-group">
                <span class="input-group-text" style="background: linear-gradient(135deg, #008000 0%, #ff6600 100%); color: white; border: none;">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="busquedaProyectos" 
                       placeholder="Buscar por t√≠tulo, √°rea, responsable, presupuesto..." 
                       onkeyup="filtrarProyectos()"
                       style="border-left: none;">
            </div>
        `;
        cardHeader.appendChild(searchContainer);
    }
});

// Funcionalidad de b√∫squeda en tiempo real
function filtrarProyectos() {
    const input = document.getElementById('busquedaProyectos');
    const filter = input.value.toLowerCase();
    const table = document.querySelector('table tbody');
    const rows = table.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            if (cells[j]) {
                const textValue = cells[j].textContent || cells[j].innerText;
                if (textValue.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}
</script>
{% endblock %}